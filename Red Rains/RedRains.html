<main>
    <div class="title"><h1>Red Rains</h1></div>
    <div class="character-info">
        <div class="character-info-item">
            <h4>Name:</h4> 
            <input type="text" name="attr_character-name" value=""></input>
        </div>
        <div class="character-info-item">
            <h4>Faith:</h4> 
            <input type="text" name="attr_character-faith" value=""></input>
        </div>
        <div class="character-info-item">
            <h4>Species:</h4> 
            <input type="text" name="attr_species" value=""></input>
        </div>
        <div class="character-info-item">
            <h4>Race:</h4> 
            <input type="text" name="attr_race" value=""></input>
        </div>
        <div class="character-info-item">
            <h4>Wealth:&nbsp;&nbsp;</h4> <!--I am sorry-->
            <input type="number" name="attr_wealth" value="1"></input>
        </div>
        <div class="character-info-item character-info-enl">
            <h4>Enlightenment:</h4> 
            <input type="number" name="attr_enl" value="30"></input>
        </div>
    </div>

    <input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab"  value="skills"/>
    <div class = "tab-bar">
        <button type="action" name="act_skills" class = "tab-button">Skills</button>
        <button type="action" name="act_magic" class = "tab-button">Magic</button>
        <button type="action" name="act_combat" class = "tab-button">Combat</button>
        <button type="action" name="act_inventory" class = "tab-button">Inventory</button>
        <button type="action" name="act_notes" class = "tab-button">Notes</button>
    </div>

    <div class="sidebar">
        <div class="character-overview">
            <div class="character-overview-item">
                <h4>Strain:</h4>
                <input type="number" name="attr_strain" value="0"/>
            </div>
            <div class="character-overview-item">
                <h4>Wounded:</h4>
                <input type="checkbox" name="attr_wounded"/>
            </div>
            <div class="character-overview-item">
                <h4>Black&nbsp;mark:</h4>
                <input type="checkbox" name="attr_blackmark"/>
            </div>
            <div class="character-overview-item">
                <h4>Blood&nbsp;mark:</h4>
                <input type="checkbox" name="attr_bloodmark"/>
            </div>
        </div>
        <div>
            <br><h3>Languages</h3>
            <div class="language">
                <h4>Name</h4>
                <h4 title="Spoken">S</h4>
                <h4 title="Written">W</h4>
            </div>
            <fieldset class="repeating_languages">
                <div class="language">
                    <input type="text" name="attr_language">
                    <input type="checkbox" name="attr_spoken"/>
                    <input type="checkbox" name="attr_written"/>
                </div>
            </fieldset>
        </div>
        <h3><br>Abilities</h3>
        <div class="abilities-container">
            <fieldset class="repeating_abilities">
                <div class="ability">
                    <input type="text" name="attr_abilitty_name">
                    <details class = "ability_desc">
                        <summary></summary>
                        <textarea name="attr_abilitty_description" placeholder="Description"></textarea>
                        <button type="roll" name="attr_ability_roll" value="&{template:default}{{name=@{abilitty_name}}}{{@{abilitty_description}}}"> Display in chat</button>
                    </details>
                </div>
            </fieldset>
        </div>
        </div>
    </div>

    <div class="sheet-skills">
        <div class="skills-grid">
            <div class="skills-grid-header"><h3>Social</h3></div>

            <h4></h4>
            <h4>Name</h4>
            <h4>Grade</h4>
            <h4>Potential</h4>
            <h4>Focuses</h4>
            
            <button type="action" name="act_leadership" class="skill-roll-button">Roll</button>
            <div>Leadership</div>
            <input class="skills-grid-input" type="number" name="attr_leadership-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_leadership-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_leadership-focuses" value=""></input>
            
            <button type="action" name="act_persuasion" class="skill-roll-button">Roll</button>
            <div>Persuasion</div>
            <input class="skills-grid-input" type="number" name="attr_persuasion-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_persuasion-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_persuasion-focuses" value=""></input>

            <button type="action" name="act_intimidation" class="skill-roll-button">Roll</button>
            <div>Intimidation</div>
            <input class="skills-grid-input" type="number" name="attr_intimidation-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_intimidation-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_intimidation-focuses" value=""></input>

            <button type="action" name="act_insight" class="skill-roll-button">Roll</button>
            <div>Insight</div>
            <input class="skills-grid-input" type="number" name="attr_insight-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_insight-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_insight-focuses" value=""></input>
            
            <button type="action" name="act_deceit" class="skill-roll-button">Roll</button>
            <div>Deceit</div>
            <input class="skills-grid-input" type="number" name="attr_deceit-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_deceit-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_deceit-focuses" value=""></input>

            <button type="action" name="act_barter" class="skill-roll-button">Roll</button>
            <div>Barter</div>
            <input class="skills-grid-input" type="number" name="attr_barter-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_barter-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_barter-focuses" value=""></input>

            <div class="skills-grid-header"><h3>Intellect</h3></div>

            <button type="action" name="act_linguistics" class="skill-roll-button">Roll</button>
            <div>Linguistics</div>
            <input class="skills-grid-input" type="number" name="attr_linguistics-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_linguistics-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_linguistics-focuses" value=""></input>
            
            <button type="action" name="act_medicine" class="skill-roll-button">Roll</button>
            <div>Medicine</div>
            <input class="skills-grid-input" type="number" name="attr_medicine-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_medicine-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_medicine-focuses" value=""></input>

            <button type="action" name="act_mechanics" class="skill-roll-button">Roll</button>
            <div>Mechanics</div>
            <input class="skills-grid-input" type="number" name="attr_mechanics-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_mechanics-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_mechanics-focuses" value=""></input>

            <button type="action" name="act_investigation" class="skill-roll-button">Roll</button>
            <div>Investigation</div>
            <input class="skills-grid-input" type="number" name="attr_investigation-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_investigation-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_investigation-focuses" value=""></input>
            
            <button type="action" name="act_acumen" class="skill-roll-button">Roll</button>
            <div>Acumen</div>
            <input class="skills-grid-input" type="number" name="attr_acumen-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_acumen-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_acumen-focuses" value=""></input>

            <div class="skills-grid-header"><h3>Physique</h3></div>

            <button type="action" name="act_craft" class="skill-roll-button">Roll</button>
            <div>Craft</div>
            <input class="skills-grid-input" type="number" name="attr_craft-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_craft-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_craft-focuses" value=""></input>
            
            <button type="action" name="act_mele" class="skill-roll-button">Roll</button>
            <div>Mele</div>
            <input class="skills-grid-input" type="number" name="attr_mele-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_mele-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_mele-focuses" value=""></input>

            <button type="action" name="act_brawl" class="skill-roll-button">Roll</button>
            <div>Brawl</div>
            <input class="skills-grid-input" type="number" name="attr_brawl-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_brawl-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_brawl-focuses" value=""></input>

            <button type="action" name="act_marksman" class="skill-roll-button">Roll</button>
            <div>Marksman</div>
            <input class="skills-grid-input" type="number" name="attr_marksman-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_marksman-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_marksman-focuses" value=""></input>
            
            <button type="action" name="act_endurance" class="skill-roll-button">Roll</button>
            <div>Endurance</div>
            <input class="skills-grid-input" type="number" name="attr_endurance-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_endurance-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_endurance-focuses" value=""></input>

            <button type="action" name="act_stealth" class="skill-roll-button">Roll</button>
            <div>Stealth</div>
            <input class="skills-grid-input" type="number" name="attr_stealth-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_stealth-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_stealth-focuses" value=""></input>

            <button type="action" name="act_agility" class="skill-roll-button">Roll</button>
            <div>Agility</div>
            <input class="skills-grid-input" type="number" name="attr_agility-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_agility-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_agility-focuses" value=""></input>

            <div class="skills-grid-header"><h3>Wisdom</h3></div>

            <button type="action" name="act_art" class="skill-roll-button">Roll</button>
            <div>Art</div>
            <input class="skills-grid-input" type="number" name="attr_art-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_art-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_art-focuses" value=""></input>
            
            <button type="action" name="act_survival" class="skill-roll-button">Roll</button>
            <div>Survival</div>
            <input class="skills-grid-input" type="number" name="attr_survival-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_survival-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_survival-focuses" value=""></input>

            <button type="action" name="act_willpower" class="skill-roll-button">Roll</button>
            <div>Willpower</div>
            <input class="skills-grid-input" type="number" name="attr_willpower-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_willpower-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_willpower-focuses" value=""></input>

            <button type="action" name="act_spellweave" class="skill-roll-button">Roll</button>
            <div>Spellweave</div>
            <input class="skills-grid-input" type="number" name="attr_spellweave-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_spellweave-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_spellweave-focuses" value=""></input>
            
            <button type="action" name="act_aura" class="skill-roll-button">Roll</button>
            <div>Aura</div>
            <input class="skills-grid-input" type="number" name="attr_aura-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_aura-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_aura-focuses" value=""></input>

            <button type="action" name="act_perception" class="skill-roll-button">Roll</button>
            <div>Perception</div>
            <input class="skills-grid-input" type="number" name="attr_perception-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_perception-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_perception-focuses" value=""></input>

            <button type="action" name="act_feral" class="skill-roll-button">Roll</button>
            <div>Feral</div>
            <input class="skills-grid-input" type="number" name="attr_feral-grade" value="1"></input>
            <input class="skills-grid-input" type="number" name="attr_feral-potential" value="10"></input>
            <input class="skills-grid-input" type="text" name="attr_feral-focuses" value=""></input>

        </div>
    </div>
    <div class="sheet-magic">
        <h2>Magic</h2>
        <span>Magic goes here</span> 
    </div>
    <div class="sheet-combat">
        <h2>Combat</h2>
        <span>All weapons, rotes and other combat buttons go here</span> 
    </div>
    <div class="sheet-inventory">
        <h2>Inventory</h2>
        <span>All of the furniture you managed to steal</span> 
    </div>
    <div class="sheet-notes">
        <h2>Notes</h2>
        <span>Various notes, descriptions, scars and more</span> 
    </div>

</main>

<rolltemplate class="sheet-rolltemplate-redrains">
    <h3>{{name}}</h3>
    <div class="sheet-results">
        <h4>Sucesses: {{computed::roll1}}</h4>
    </div>
</rolltemplate>

<script>
    $('.expandButton').click(function() {
        console.log("Expand clicked")
        $(this).parent().find('.ability_desc').slideToggle(function() {
            $('.isotope').isotope("layout");
        });
        $(this).addClass('open');
    });
</script>

<script type="text/worker">

    /*on("clicked:repeating_abilities:expand", function() {
        console.log(this.parent);
        getSectionIDs("abilities", function(idarray) {
            console.log(idarray);
        });
    });*/
    
    const tabButtonList = ["skills","magic","combat","inventory","notes"];
    tabButtonList.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });

    // List of all of the possible skills
    const skillList = [
        "leadership", "persuasion", "intimidation", "insight", "deceit", "barter",  // Social
        "linguistics", "medicine", "mechanics", "investigation", "acumen",          // Intellect
        "craft", "mele", "brawl", "marksman", "endurance", "stealth", "agility",    // Physique
        "art", "survival", "willpower", "spellweave", "perception", "aura", "feral" // Wisdom
    ];

    // Define each ability roll button and invoke the ability roll function when the button is clocked
    skillList.forEach(skill => {
        on(`clicked:${skill}`, (info) => {
            const skillName = info.triggerName.substring('clicked:'.length);
            rollSkill(skillName)
        });
    })

    //If each of the abilities change make sure they can't go below 0 or above potential
    skillList.forEach(skill => {
        on(`change:${skill}-grade`, (info) => {
            // Get base skill name
            const skillName = info.triggerName.substring(0, info.triggerName.length - "-grade".length);
            // Get skill grade variable name
            const skillGradeName = info.triggerName.toString();
            //Get variables
            getAttrs([skillGradeName, skillName+"-potential"], function(values) {
                var skillGrade = parseInt(values[skillGradeName]);
                var skillPotential = parseInt(values[skillName+"-potential"]);

                // If skill grade is higher than potential, set it to potential. If it is lower than 1, set it to 1
                if(skillGrade > skillPotential){
                    setAttrs({ [skillGradeName]: skillPotential  });
                } else if (skillGrade < 0){
                    setAttrs({ [skillGradeName]: 0  });
                }
            })
        });
    })

    /*
     * Rolls any skill with the supplied skill name - checks for focuses and adds those accordingly.
     */
    function rollSkill(skillName){
        //Base roll macro for every skills (Capitalize 1st letter of name param for display purposes)
        const rollFormula = "&{template:redrains} {{name="+skillName.charAt(0).toUpperCase() + skillName.slice(1)+"}} {{roll1=[[(@{"+skillName+"-grade}-@{strain})d6>4]]}}"
        getAttrs([skillName+"-focuses", skillName+"-grade", "strain"], function(values) {
            const focus = values[skillName+"-focuses"].toString();
            if(focus == ""){
                //If there are no focuses there is no need to promt the user - just roll the basic formula
                startRoll(rollFormula, (results) =>{
                    finishRoll(
                        results.rollId
                    );
                });
            } else {
                const grade = parseInt(values[skillName+"-grade"])
                const strain = parseInt(values["strain"]);
                //If there is a focus we need to ask the user if the focus applies and how many times it applies (up to 2)
                startRoll(rollFormula.replace("d6>4","d6>4 +?{Does your focus apply?|No, 0|Yes - once, 1|Yes - twice, 2}"), (results) => {
                    var sucesses = results.results.roll1.result
                    //If user has more sucesses than his maximum dice pool allows, then the number of sucessed becomes equal to dice pool
                    const dicePool = grade - strain
                    if (sucesses > dicePool){
                        sucesses = dicePool;
                    }
                    finishRoll(
                        results.rollId, {
                            roll1: sucesses
                        }
                    );
                })
            }
        })
    } 

</script>